<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ KI-Lern-Buddy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        header { 
            text-align: center; margin-bottom: 30px; color: white; 
            display: flex; justify-content: space-between; align-items: center;
        }
        header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        header p { font-size: 1.2rem; opacity: 0.9; }
        .user-info { 
            background: rgba(255,255,255,0.2); padding: 10px 20px; 
            border-radius: 10px; display: flex; align-items: center; gap: 10px;
        }
        .card { 
            background: white; border-radius: 15px; padding: 25px; 
            margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .card h2 { 
            color: #333; margin-bottom: 20px; font-size: 1.5rem; 
            border-bottom: 2px solid #667eea; padding-bottom: 10px;
        }
        .form-group { 
            display: flex; flex-wrap: wrap; gap: 10px; align-items: end; 
        }
        input { 
            padding: 12px 15px; border: 2px solid #e1e5e9; border-radius: 8px; 
            font-size: 16px; flex: 1; min-width: 150px; 
        }
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; border: none; padding: 12px 25px; border-radius: 8px; 
            font-size: 16px; cursor: pointer; font-weight: 600; 
        }
        button:hover { transform: translateY(-2px); }
        button.logout { 
            background: #dc3545; padding: 8px 15px; font-size: 14px; 
        }
        button.school { 
            background: #28a745; padding: 8px 15px; font-size: 14px; 
        }
        .output { 
            background: #f8f9fa; border-radius: 10px; padding: 20px; 
            margin-top: 15px; border-left: 4px solid #667eea; 
            max-height: 500px; overflow-y: auto; 
        }
        .exercise {
            background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px;
            border-left: 4px solid #28a745;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .loading { color: #667eea; font-style: italic; }
        .debug { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; color: #666; display: none; }
        .school-info {
            background: #e7f3ff; padding: 10px 15px; border-radius: 8px; margin-top: 10px;
            border-left: 4px solid #007bff;
        }
        .history-item {
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 10px;
    background: white;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .test-details {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .score.excellent { color: #28a745; font-weight: bold; }
        .score.good { color: #ffc107; font-weight: bold; }
        .score.poor { color: #dc3545; font-weight: bold; }

        .test-performance {
            font-size: 0.9em;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div>
                <h1>ü§ñ KI-Lern-Buddy</h1>
                <p>Intelligente Lernunterst√ºtzung mit KI-Personalisierung</p>
            </div>
            <div class="user-info">
                <span id="usernameDisplay">Lade...</span>
                <button class="school" onclick="showSchoolSetup()">üè´ Schulkonfig</button>
                <button class="logout" onclick="logout()">Logout</button>
                <button onclick="toggleDebug()" style="background: #6c757d; padding: 5px 10px; font-size: 12px;">Debug</button>
            </div>

            <button onclick="goToTest()" style="background: #28a745; margin-left: 10px;">
                üß™ Test-Modus
            </button>

            <script>
            function goToTest() {
                window.location.href = '/test';
            }
            </script>
        </header>

        <div id="debug" class="debug"></div>

        <div class="card">
            <h2>üè´ Meine Schule</h2>
            <div id="schoolInfo" class="school-info">
                Lade Schulinformationen...
            </div>
            <div class="form-group" style="margin-top: 15px;">
                <button onclick="loadSchoolContext()">Schuldaten aktualisieren</button>
                <button onclick="showSchoolSetup()" style="background: #28a745;">Schulkonfiguration bearbeiten</button>
            </div>
        </div>

        <div class="card">
            <h2>üìö √úbungen generieren</h2>
            <div class="form-group">
                <input type="text" id="subject" placeholder="Fach" value="Mathe">
                <input type="text" id="topic" placeholder="Thema" value="Analysis">
                <input type="number" id="count" placeholder="Anzahl" value="2" min="1" max="5">
                <button onclick="generateExercises()">√úbungen generieren</button>
            </div>
        </div>

        <div class="card">
            <h2>üìä Lern-Session tracken</h2>
            <div class="form-group">
                <input type="text" id="sessionSubject" placeholder="Fach" value="Mathe">
                <input type="number" id="duration" placeholder="Dauer (Minuten)" value="45">
                <input type="text" id="sessionTopics" placeholder="Themen (komma-getrennt)" value="Analysis,Ableitungen">
                <input type="number" id="performance" placeholder="Performance (0-1)" value="0.8" step="0.1" min="0" max="1">
                <button onclick="trackSession()">Session speichern</button>
            </div>
        </div>

        <div class="card">
            <h2>üìà Analytics & Profil</h2>
            <div class="form-group">
                <button onclick="showAnalytics()">Analytics laden</button>
                <button onclick="showProfile()">Profil anzeigen</button>
                <button onclick="showRecommendations()">Empfehlungen</button>
            </div>
        </div>

        <div class="card">
            <h2>üîÆ Ergebnisse</h2>
            <div id="output" class="output">
                Willkommen beim KI-Lern-Buddy! W√§hle eine Aktion aus.
            </div>
        </div>
    </div>

    <div class="card">
        <h2>üìä Test-Historie</h2>
        <div id="testHistory">
            <p>Lade Test-Historie...</p>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let currentUsername = '';
        let debugEnabled = false;

        // Beim Laden Auth pr√ºfen
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
        });

        function debugLog(message) {
            if (!debugEnabled) return;
            const debugDiv = document.getElementById('debug');
            debugDiv.innerHTML += `<div>${new Date().toLocaleTimeString()}: ${message}</div>`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        function toggleDebug() {
            debugEnabled = !debugEnabled;
            document.getElementById('debug').style.display = debugEnabled ? 'block' : 'none';
            debugLog('Debug mode ' + (debugEnabled ? 'enabled' : 'disabled'));
        }

        async function checkAuthentication() {
            debugLog('Starte Authentifizierungspr√ºfung...');
            const token = localStorage.getItem('token');
            
            if (!token) {
                debugLog('Kein Token gefunden - redirect zu Login');
                window.location.href = '/login';
                return;
            }

            debugLog('Token gefunden, pr√ºfe G√ºltigkeit...');
            
            try {
                const response = await fetch(`${API_BASE}/api/check-auth`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    currentUsername = result.user.sub;
                    document.getElementById('usernameDisplay').textContent = currentUsername;
                    debugLog('Erfolgreich authentifiziert als: ' + currentUsername);
                    
                    // Lade Schulkontext
                    loadSchoolContext();
                } else {
                    debugLog('Token ung√ºltig - redirect zu Login');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/login';
                }
            } catch (error) {
                debugLog('Fehler bei Auth-Check: ' + error.message);
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = '/login';
            }
        }

        async function loadSchoolContext() {
            try {
                const result = await apiCall('/api/school-context');
                const schoolInfo = document.getElementById('schoolInfo');
                
                if (result.data && result.data.school_type) {
                    schoolInfo.innerHTML = `
                        <strong>${result.data.school_type}</strong> - Klasse ${result.data.grade}<br>
                        Bundesland: ${result.data.state} | Schwerpunkt: ${result.data.curriculum_focus}
                    `;
                } else {
                    schoolInfo.innerHTML = `
                        <strong>Noch keine Schulkonfiguration</strong><br>
                        <a href="#" onclick="showSchoolSetup(); return false;">Jetzt Schuldaten eingeben</a> f√ºr bessere Personalisierung
                    `;
                }
            } catch (error) {
                document.getElementById('schoolInfo').innerHTML = 'Fehler beim Laden der Schuldaten';
            }
        }

        function showOutput(message, className = '') {
            const output = document.getElementById('output');
            output.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function showJsonOutput(data, title = 'Daten') {
            const output = document.getElementById('output');
            output.innerHTML = `
                <h3>${title}</h3>
                <pre>${JSON.stringify(data, null, 2)}</pre>
            `;
        }

        async function apiCall(endpoint, method = 'GET', data = null) {
            const token = localStorage.getItem('token');
            
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                showOutput('üîÑ Lade...', 'loading');
                debugLog(`API Call: ${method} ${endpoint}`);
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                };
                
                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, options);
                debugLog(`API Response: ${response.status}`);
                
                // Wenn nicht autorisiert, zum Login redirecten
                if (response.status === 401) {
                    debugLog('API: 401 Unauthorized - redirect zu Login');
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = '/login';
                    return;
                }
                
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.detail || 'Unbekannter Fehler');
                }
                
                return result;
            } catch (error) {
                showOutput(`‚ùå Fehler: ${error.message}`, 'error');
                debugLog('API Fehler: ' + error.message);
                throw error;
            }
        }

        async function generateExercises() {
            try {
                const data = {
                    subject: document.getElementById('subject').value,
                    topic: document.getElementById('topic').value,
                    count: parseInt(document.getElementById('count').value)
                };
                
                const result = await apiCall('/api/generate-exercises', 'POST', data);
                
                if (result.data && result.data.exercises) {
                    let html = `<h3>‚úÖ ${result.message}</h3>`;
                    result.data.exercises.forEach((exercise, index) => {
                        html += `
                            <div class="exercise">
                                <h3>Aufgabe ${index + 1}</h3>
                                <p><strong>Frage:</strong> ${exercise.question}</p>
                                <p><strong>L√∂sung:</strong> ${exercise.solution}</p>
                                <p><strong>Erkl√§rung:</strong> ${exercise.explanation}</p>
                                <p><strong>Schwierigkeit:</strong> ${exercise.difficulty}</p>
                                <p><em>${exercise.personalization_note || ''}</em></p>
                            </div>
                        `;
                    });
                    
                    if (result.data.adaptive_tips) {
                        html += `<h4>üí° Tipps:</h4><ul>`;
                        result.data.adaptive_tips.forEach(tip => {
                            html += `<li>${tip}</li>`;
                        });
                        html += `</ul>`;
                    }
                    
                    document.getElementById('output').innerHTML = html;
                }
            } catch (error) {
                // Fehler wird schon in apiCall angezeigt
            }
        }

        async function trackSession() {
            try {
                const data = {
                    subject: document.getElementById('sessionSubject').value,
                    duration_minutes: parseInt(document.getElementById('duration').value),
                    topics: document.getElementById('sessionTopics').value.split(',').map(s => s.trim()),
                    performance_score: parseFloat(document.getElementById('performance').value),
                    engagement_level: 0.7
                };
                
                const result = await apiCall('/api/track-session', 'POST', data);
                showOutput(`‚úÖ ${result.message}`, 'success');
            } catch (error) {
                // Fehler wird schon in apiCall angezeigt
            }
        }

        async function showAnalytics() {
            try {
                const result = await apiCall('/api/analytics');
                showJsonOutput(result.data, 'üìä Lern-Analytics');
            } catch (error) {
                // Fehler wird schon in apiCall angezeigt
            }
        }

        async function showProfile() {
            try {
                const result = await apiCall('/api/profile');
                showJsonOutput(result.data, 'üë§ Lern-Profil');
            } catch (error) {
                // Fehler wird schon in apiCall angezeigt
            }
        }

        async function showRecommendations() {
            try {
                const result = await apiCall('/api/recommendations');
                showJsonOutput(result.data, 'üéØ Pers√∂nliche Empfehlungen');
            } catch (error) {
                // Fehler wird schon in apiCall angezeigt
            }
        }

        function showSchoolSetup() {
            window.location.href = '/school-setup';
        }

        function logout() {
            debugLog('Logout durchgef√ºhrt');
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // Initial Debug
        debugLog('App geladen - Token: ' + (localStorage.getItem('token') ? 'vorhanden' : 'fehlt'));
        async function loadTestHistory() {
    try {
        const result = await apiCall('/api/test-history?limit=10');
        if (result.success) {
            displayTestHistory(result.data);
        }
    } catch (error) {
        document.getElementById('testHistory').innerHTML = 
            '<p class="error">Fehler beim Laden der Historie</p>';
    }
}

        function displayTestHistory(history) {
            const container = document.getElementById('testHistory');
            
            if (history.length === 0) {
                container.innerHTML = '<p>Noch keine Tests durchgef√ºhrt.</p>';
                return;
            }
            
            let html = '<div class="history-list">';
            history.forEach(test => {
                const date = new Date(test.date).toLocaleDateString('de-DE');
                html += `
                    <div class="history-item">
                        <div class="test-header">
                            <strong>${test.subject} - ${test.topic}</strong>
                            <span class="score ${test.score >= 80 ? 'excellent' : test.score >= 60 ? 'good' : 'poor'}">
                                ${Math.round(test.score)}%
                            </span>
                        </div>
                        <div class="test-details">
                            <span>${date}</span>
                            <span>${test.correct_answers}/${test.total_questions} richtig</span>
                            <span>${Math.round(test.time_spent_seconds / 60)} Min</span>
                        </div>
                        <div class="test-performance">
                            Leistung: ${test.performance_level}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Beim Laden der Hauptseite aufrufen
        if (document.getElementById('testHistory')) {
            loadTestHistory();
        }
    </script>
</body>
</html>